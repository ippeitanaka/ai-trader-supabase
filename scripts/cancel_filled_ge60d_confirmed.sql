-- Confirmed-safe cleanup: cancel FILLED rows for tickets verified as NOT OPEN in MT5
--
-- Preconditions (you confirmed): these order_ticket are not currently held.
--
-- Safety guards in WHERE:
-- - is_virtual=false
-- - actual_result='FILLED'
-- - closed_at IS NULL
-- - exit_price/profit_loss IS NULL (avoid touching rows that look partially closed)
-- - order_ticket IN (confirmed list)
--
-- Workflow:
-- 1) Run this whole script in Supabase SQL Editor.
-- 2) Check will_cancel_count and preview rows.
-- 3) If OK, uncomment COMMIT.

BEGIN;

-- Preview: how many rows will be updated
SELECT COUNT(*) AS will_cancel_count
FROM public.ai_signals
WHERE COALESCE(is_virtual,false)=false
  AND actual_result='FILLED'
  AND closed_at IS NULL
  AND exit_price IS NULL
  AND profit_loss IS NULL
  AND order_ticket IN (5070821650, 5070845404, 5070847742, 5070880808, 5070914391, 5071213870, 5071213871, 5071220432, 5071260833, 5071261114, 5071267659, 5071370259, 5071442525, 5071511055, 5071802371, 5071878045, 5071878841, 5071924947, 5071932873, 5072047589, 5072053041, 5072112756, 5072177536, 5072197535, 5072261361, 5072347047, 5072364384, 5072482140, 5072695022, 5072809179, 5073230179, 5073622773, 5073651967, 5075090835, 5075863853, 5076702722, 5077202720, 5077214027, 5077773136, 5077860998, 5077872864, 5086972210);

-- Preview sample (newest 50)
SELECT
  id, created_at, symbol, timeframe, dir, win_prob,
  order_ticket, entry_price, exit_price, profit_loss, actual_result, closed_at
FROM public.ai_signals
WHERE COALESCE(is_virtual,false)=false
  AND actual_result='FILLED'
  AND closed_at IS NULL
  AND exit_price IS NULL
  AND profit_loss IS NULL
  AND order_ticket IN (5070821650, 5070845404, 5070847742, 5070880808, 5070914391, 5071213870, 5071213871, 5071220432, 5071260833, 5071261114, 5071267659, 5071370259, 5071442525, 5071511055, 5071802371, 5071878045, 5071878841, 5071924947, 5071932873, 5072047589, 5072053041, 5072112756, 5072177536, 5072197535, 5072261361, 5072347047, 5072364384, 5072482140, 5072695022, 5072809179, 5073230179, 5073622773, 5073651967, 5075090835, 5075863853, 5076702722, 5077202720, 5077214027, 5077773136, 5077860998, 5077872864, 5086972210)
ORDER BY created_at DESC
LIMIT 50;

-- Update (returns changed rows)
UPDATE public.ai_signals
SET
  actual_result='CANCELLED',
  cancelled_reason=COALESCE(cancelled_reason,'stale_cleanup:filled_confirmed_not_open'),
  closed_at=COALESCE(closed_at,NOW()),
  hold_duration_minutes=COALESCE(
    hold_duration_minutes,
    GREATEST(0, FLOOR(EXTRACT(EPOCH FROM (NOW()-created_at))/60))::int
  )
WHERE COALESCE(is_virtual,false)=false
  AND actual_result='FILLED'
  AND closed_at IS NULL
  AND exit_price IS NULL
  AND profit_loss IS NULL
  AND order_ticket IN (5070821650, 5070845404, 5070847742, 5070880808, 5070914391, 5071213870, 5071213871, 5071220432, 5071260833, 5071261114, 5071267659, 5071370259, 5071442525, 5071511055, 5071802371, 5071878045, 5071878841, 5071924947, 5071932873, 5072047589, 5072053041, 5072112756, 5072177536, 5072197535, 5072261361, 5072347047, 5072364384, 5072482140, 5072695022, 5072809179, 5073230179, 5073622773, 5073651967, 5075090835, 5075863853, 5076702722, 5077202720, 5077214027, 5077773136, 5077860998, 5077872864, 5086972210)
RETURNING id, created_at, symbol, timeframe, order_ticket;

-- Post-check (still FILLED among these tickets?)
SELECT COUNT(*) AS remaining_filled_count
FROM public.ai_signals
WHERE COALESCE(is_virtual,false)=false
  AND actual_result='FILLED'
  AND closed_at IS NULL
  AND order_ticket IN (5070821650, 5070845404, 5070847742, 5070880808, 5070914391, 5071213870, 5071213871, 5071220432, 5071260833, 5071261114, 5071267659, 5071370259, 5071442525, 5071511055, 5071802371, 5071878045, 5071878841, 5071924947, 5071932873, 5072047589, 5072053041, 5072112756, 5072177536, 5072197535, 5072261361, 5072347047, 5072364384, 5072482140, 5072695022, 5072809179, 5073230179, 5073622773, 5073651967, 5075090835, 5075863853, 5076702722, 5077202720, 5077214027, 5077773136, 5077860998, 5077872864, 5086972210);

-- COMMIT;   -- ← uncomment after verifying preview + RETURNING
ROLLBACK;    -- ← safety default
