name: Trade System Check

# トレードシステムの稼働チェック
# OpenAI API接続、各Edge Functionの動作確認

on:
  # 毎日 UTC 0:00, 6:00, 12:00, 18:00 (6時間ごと)
  schedule:
    - cron: '0 0,6,12,18 * * *'
  
  # 手動実行も可能
  workflow_dispatch:

jobs:
  system-health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    concurrency:
      group: trade-system-check
      cancel-in-progress: true
    
    steps:
      - name: 🏥 トレードシステム稼働チェック開始
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🏥 Trade System Health Check"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "実行時刻: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "実行時刻 (JST): $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      
      - name: 1️⃣ ai-trader エンドポイント確認
        id: check_ai_trader
        run: |
          echo "📡 ai-trader エンドポイントをチェック中..."

          # Fail fast and avoid hanging
          set -euo pipefail

          CURL_EXIT=0
          RESPONSE=$(curl --retry 3 --retry-all-errors --retry-delay 5 --connect-timeout 10 --max-time 90 -sS -w "\n%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/ai-trader" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "symbol": "USDJPY",
              "timeframe": "H1",
              "price": 150.50,
              "bid": 150.49,
              "ask": 150.51,
              "rsi": 45.5,
              "atr": 0.0008,
              "ema_25": 150.40,
              "sma_100": 150.30,
              "sma_200": 150.20,
              "sma_800": 150.10,
              "ma_cross": 1,
              "macd": {
                "main": 0.05,
                "signal": 0.03,
                "histogram": 0.02,
                "cross": 1
              },
              "ichimoku": {
                "tenkan": 150.60,
                "kijun": 150.50,
                "senkou_a": 150.55,
                "senkou_b": 150.45,
                "chikou": 150.40,
                "tk_cross": 1,
                "cloud_color": 1,
                "price_vs_cloud": 1
              },
              "ea_suggestion": {
                "dir": 1,
                "tech_dir": 1,
                "reason": "github-actions health check",
                "ichimoku_score": 0.5
              },
              "test_mode": true
            }' 2>&1) || CURL_EXIT=$?

          if [ "$CURL_EXIT" -ne 0 ]; then
            echo "❌ curl failed (exit=$CURL_EXIT)"
            echo "$RESPONSE"
            exit 1
          fi
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "$BODY" | jq '.' || echo "$BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ ai-trader: 正常"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "❌ ai-trader: エラー (HTTP $HTTP_CODE)"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: 2️⃣ OpenAI API 接続確認
        id: check_openai
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🤖 OpenAI API 接続確認"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          set -euo pipefail
          CURL_EXIT=0
          RESPONSE=$(curl --retry 3 --retry-all-errors --retry-delay 5 --connect-timeout 10 --max-time 120 -sS -w "\n%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/ai-trader" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "symbol": "EURUSD",
              "timeframe": "H4",
              "price": 1.0850,
              "bid": 1.0849,
              "ask": 1.0851,
              "rsi": 65.0,
              "atr": 0.0012,
              "ema_25": 1.0860,
              "sma_100": 1.0870,
              "sma_200": 1.0880,
              "sma_800": 1.0900,
              "ma_cross": -1,
              "macd": {
                "main": -0.02,
                "signal": -0.01,
                "histogram": -0.01,
                "cross": -1
              },
              "ichimoku": {
                "tenkan": 1.0840,
                "kijun": 1.0850,
                "senkou_a": 1.0845,
                "senkou_b": 1.0855,
                "chikou": 1.0860,
                "tk_cross": -1,
                "cloud_color": -1,
                "price_vs_cloud": -1
              },
              "ea_suggestion": {
                "dir": -1,
                "tech_dir": -1,
                "reason": "github-actions health check",
                "ichimoku_score": -0.5
              },
              "test_mode": true
            }' 2>&1) || CURL_EXIT=$?

          if [ "$CURL_EXIT" -ne 0 ]; then
            echo "❌ curl failed (exit=$CURL_EXIT)"
            echo "$RESPONSE"
            exit 1
          fi
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          # OpenAI APIからの応答があるかチェック
          WIN_PROB=$(echo "$BODY" | jq -r '.win_prob // empty' 2>/dev/null)
          REASONING=$(echo "$BODY" | jq -r '.reasoning // empty' 2>/dev/null)
          
          if [ -n "$WIN_PROB" ] && [ -n "$REASONING" ]; then
            echo "✅ OpenAI API: 正常接続"
            echo "   勝率予測: $WIN_PROB"
            echo "   推論取得: OK"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "❌ OpenAI API: 応答異常"
            echo "$BODY"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: 3️⃣ ML学習機能確認
        id: check_ml
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🤖 ML学習機能確認"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          set -euo pipefail
          CURL_EXIT=0
          RESPONSE=$(curl --retry 3 --retry-all-errors --retry-delay 5 --connect-timeout 10 --max-time 60 -sS -w "\n%{http_code}" -X GET \
            "${{ secrets.SUPABASE_URL }}/functions/v1/ml-training" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" 2>&1) || CURL_EXIT=$?

          if [ "$CURL_EXIT" -ne 0 ]; then
            echo "❌ curl failed (exit=$CURL_EXIT)"
            echo "$RESPONSE"
            exit 1
          fi
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "$BODY" | jq '.' || echo "$BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ ML学習機能: 正常"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "❌ ML学習機能: エラー"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: 4️⃣ ea-log エンドポイント確認
        id: check_ea_log
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📝 ea-log エンドポイント確認"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          NOW_UTC=$(date -u '+%Y-%m-%dT%H:%M:%SZ')

          # ea-log requires: sym, and at least one of (action/trade_decision/win_prob)
          set -euo pipefail
          CURL_EXIT=0
          RESPONSE=$(curl --retry 3 --retry-all-errors --retry-delay 5 --connect-timeout 10 --max-time 60 -sS -w "\n%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/ea-log" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\
              \"at\": \"${NOW_UTC}\",\
              \"sym\": \"HEALTHCHECK\",\
              \"tf\": \"H1\",\
              \"action\": \"HOLD\",\
              \"trade_decision\": \"HEALTH_CHECK\",\
              \"win_prob\": 0.5,\
              \"ai_reasoning\": \"Health check from GitHub Actions\",\
              \"caller\": \"system-health-check\",\
              \"instance\": \"github-actions\"\
            }" 2>&1) || CURL_EXIT=$?

          if [ "$CURL_EXIT" -ne 0 ]; then
            echo "❌ curl failed (exit=$CURL_EXIT)"
            echo "$RESPONSE"
            exit 1
          fi
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"

          echo "$BODY" | jq '.' || echo "$BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ ea-log: 正常"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "❌ ea-log: エラー (HTTP $HTTP_CODE)"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ✅ 全チェック完了
        if: success()
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ すべてのシステムが正常に稼働しています"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "チェック項目:"
          echo "  ✅ ai-trader エンドポイント"
          echo "  ✅ OpenAI API 接続"
          echo "  ✅ ML学習機能"
          echo "  ✅ ea-log エンドポイント"
          echo ""
          echo "実行完了時刻: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "実行完了時刻 (JST): $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      
      - name: ❌ エラー検出
        if: failure()
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "❌ システムチェックでエラーが検出されました"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "上記のログを確認してください"
          echo "Supabase Dashboard で詳細を確認:"
          echo "https://supabase.com/dashboard/project/nebphrnnpmuqbkymwefs"
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          exit 1
