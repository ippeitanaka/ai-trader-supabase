# AI_QuadFusion_EA v1.3.0 - 一目均衡表統合ガイド

## 🎯 変更点サマリー

### バージョンアップ
- **v1.2.6** → **v1.3.0**
- 名称変更: **Triple Fusion** → **Quad Fusion** (4つの融合)

### 新機能: 一目均衡表（Ichimoku Kinko Hyo）統合

## 📊 使用するテクニカル指標（4つ）

| # | 指標 | パラメータ | 用途 |
|---|------|----------|------|
| 1 | **RSI** | 期間: 14 | 買われすぎ/売られすぎ判定 |
| 2 | **ATR** | 期間: 14 | ボラティリティ測定、SL/TP計算 |
| 3 | **移動平均線** | EMA(25) vs SMA(100) | トレンド方向判定 |
| 4 | **一目均衡表** ⭐NEW | 転換線(9), 基準線(26), 先行スパン(52) | 総合的なトレンド判定 |

## 🆕 一目均衡表の判定ロジック

### 採用する5つのライン

1. **転換線** (Tenkan-sen): 9期間の高値と安値の平均
2. **基準線** (Kijun-sen): 26期間の高値と安値の平均
3. **先行スパンA** (Senkou Span A): 転換線と基準線の平均を26期間先行
4. **先行スパンB** (Senkou Span B): 52期間の高値と安値の平均を26期間先行
5. **遅行スパン** (Chikou Span): 当日の終値を26期間遅行

### シグナル判定（スコアリング方式）

```cpp
int score = 0;

// 1. 転換線と基準線のクロス（最重要: ±2点）
if(転換線 > 基準線) score += 2;  // 強い買いシグナル
if(転換線 < 基準線) score -= 2;  // 強い売りシグナル

// 2. 価格と雲の位置関係（±1点）
if(価格 > 雲の上限) score += 1;  // 買い優勢
if(価格 < 雲の下限) score -= 1;  // 売り優勢

// 3. 雲の厚さチェック
if(雲が薄い) score = 0;  // トレンド転換の可能性 → 中立

// 4. 雲の色（±1点）
if(先行スパンA > 先行スパンB) score += 1;  // 上昇雲（陽転）
if(先行スパンA < 先行スパンB) score -= 1;  // 下降雲（陰転）

// 最終判定
if(score >= 3)  → 強い買いシグナル
if(score <= -3) → 強い売りシグナル
else            → 中立
```

## 🔀 統合シグナルロジック

### 1. MA単独シグナル
- EMA(25) > SMA(100) → 買い
- EMA(25) < SMA(100) → 売り

### 2. 一目単独シグナル
- スコア >= 3 → 買い
- スコア <= -3 → 売り

### 3. 複合シグナル（優先度順）

| MA | 一目 | 最終判定 | 理由表示 | 一目スコア |
|----|------|---------|---------|-----------|
| 買い | 買い | **買い** | `MA↑+一目買` | 1.0 (最強) |
| 売り | 売り | **売り** | `MA↓+一目売` | 1.0 (最強) |
| 買い | 中立 | 買い | `MA↑` | 0.5 |
| 売り | 中立 | 売り | `MA↓` | 0.5 |
| 中立 | 買い | 買い | `一目買` | 0.7 |
| 中立 | 売り | 売り | `一目売` | 0.7 |
| 買い | 売り | **見送り** | `シグナル矛盾` | 0.0 |
| 売り | 買い | **見送り** | `シグナル矛盾` | 0.0 |

### シグナル矛盾時の動作
MAと一目のシグナルが逆の場合、**トレードを見送り**ます。これにより、不確実性の高い局面での無駄なエントリーを回避します。

## ⚙️ 新しいパラメータ

```mql5
input bool UseIchimoku = true;      // 一目均衡表を使用（ON/OFF可能）
input int  Ichimoku_Tenkan = 9;     // 転換線期間
input int  Ichimoku_Kijun = 26;     // 基準線期間
input int  Ichimoku_Senkou = 52;    // 先行スパン期間
```

### パラメータ調整のヒント

| 市場特性 | 推奨設定 | 理由 |
|---------|---------|------|
| **ボラティリティ高** | デフォルト (9/26/52) | 標準設定で対応可 |
| **レンジ相場** | UseIchimoku = false | MAのみで判断 |
| **長期トレンド** | 転換線: 12, 基準線: 36 | より長期的な視点 |
| **短期スキャルピング** | 転換線: 7, 基準線: 20 | より敏感に反応 |

## 🚀 AI連携の強化

### 送信データに追加
```json
{
  "symbol": "BTCUSD",
  "timeframe": "M15",
  "dir": 1,
  "rsi": 62.5,
  "atr": 0.00085,
  "price": 43250.50,
  "reason": "MA↑+一目買",
  "ichimoku_score": 1.0,  // ⭐NEW
  "instance": "main",
  "version": "1.3.0"
}
```

### AIエンドポイントでの活用
- `ichimoku_score`: 0.0～1.0の範囲
  - **1.0**: 両指標が一致（最強）
  - **0.7**: 一目のみ確信
  - **0.5**: MAのみ確信
  - **0.0**: シグナル矛盾

OpenAI GPTはこのスコアを考慮して、より精度の高い勝率予測を行います。

## 📈 期待される効果

### メリット

1. **誤シグナルの削減**
   - MAと一目の両方が一致した場合のみエントリー
   - 矛盾時は見送り → 勝率向上

2. **トレンド判定の強化**
   - 雲の厚さや色でトレンドの強さを判定
   - 価格と雲の位置関係で勢いを把握

3. **柔軟な設定**
   - `UseIchimoku = false` で従来の動作に戻せる
   - パラメータ調整で市場特性に対応

4. **AI予測精度の向上**
   - `ichimoku_score` を追加することでAIがより賢く判断

### デメリット

1. **エントリー機会の減少**
   - より慎重な判定になるため、トレード回数は減る可能性
   - ただし勝率は向上が期待できる

2. **計算負荷の増加**
   - 一目均衡表の計算が追加される（ただし軽微）

3. **最適化の複雑化**
   - パラメータが増えるため、バックテストが重要

## 🧪 テスト推奨手順

### 1. デフォルト設定でテスト
```
UseIchimoku = true
Ichimoku_Tenkan = 9
Ichimoku_Kijun = 26
Ichimoku_Senkou = 52
```

### 2. 一目なしで比較
```
UseIchimoku = false
```
→ v1.2.6相当の動作で比較検証

### 3. ログ確認
ea-logで `reason` フィールドを確認:
- `MA↑+一目買` → 両方一致（期待大）
- `MA↑` → MAのみ（通常）
- `シグナル矛盾` → 見送り

### 4. 勝率分析
一目スコア別の勝率を集計:
```sql
SELECT 
  CASE 
    WHEN reason LIKE '%一目%' THEN 'Ichimoku強'
    ELSE 'MA単独'
  END as signal_type,
  COUNT(*) as trades,
  AVG(win_prob) as avg_win_prob
FROM "ea-log"
WHERE action IN ('BUY','SELL')
GROUP BY signal_type;
```

## 📚 参考情報

### 一目均衡表の基本原則

1. **三役好転** (最強の買いシグナル)
   - 転換線が基準線を上抜け
   - 価格が雲の上
   - 遅行スパンが価格を上抜け

2. **三役逆転** (最強の売りシグナル)
   - 転換線が基準線を下抜け
   - 価格が雲の下
   - 遅行スパンが価格を下抜け

このEAでは **転換線・基準線・雲** の3要素を主に使用しています。

## 🔧 トラブルシューティング

### Q1: エントリーが極端に減った
**A**: `UseIchimoku = false` で一目を無効化して比較。一目の判定が厳しすぎる場合は、スコア判定基準を調整可能（コード内の `if(score>=3)` を `if(score>=2)` に変更）

### Q2: "シグナル矛盾" が多い
**A**: レンジ相場の可能性。一時的に `UseIchimoku = false` に設定するか、より短期の一目パラメータを試す

### Q3: 一目均衡表が表示されない
**A**: MT5チャートで手動追加: 挿入 → インジケーター → トレンド → Ichimoku Kinko Hyo

---

**変更履歴**:
- v1.3.0 (2025-10-15): 一目均衡表を統合、Quad Fusion化
- v1.2.6: ベースバージョン
